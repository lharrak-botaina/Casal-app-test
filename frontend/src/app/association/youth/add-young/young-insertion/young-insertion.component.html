<ng-container *ngFor="let item of INSERTION['controls']['list']['controls']; let i = index">
  <ng-container [formGroup]="INSERTION['controls']['list']['controls'][i]">

    <!-- Job Interviews Section -->
    <div class="form-section">
      <div class="section-header">
        <div class="section-icon">
          <mat-icon>assignment_ind</mat-icon>
        </div>
        <h4 class="section-title">Entretiens d'Embauche</h4>
      </div>

      <ng-container
        *ngFor="
          let item of INSERTION.controls['list']['controls'][i]['controls']['tracking_before'][
            'controls'
          ];
          let j = index
        "
      >
        <div class="dynamic-item-card">
          <ng-container
            [formGroup]="
              INSERTION.controls['list']['controls'][i]['controls']['tracking_before']['controls'][j]
            "
          >
            <div class="item-header">
              <h6 class="item-title">
                <span class="item-number">{{ j + 1 }}</span>
                Entretien
              </h6>
              <div class="item-actions">
                <button type="button" class="btn-add" (click)="addBeforeInsertion(i)">
                  <mat-icon>add</mat-icon>
                </button>
                <button
                  type="button"
                  *ngIf="j != 0"
                  class="btn-remove"
                  (click)="removeBeforeInsertion(i, j)"
                >
                  <mat-icon>close</mat-icon>
                </button>
              </div>
            </div>

            <div class="form-grid">
              <div>
                <app-date-input
                  [formControl]="
                    INSERTION.controls['list']['controls'][i]['controls']['tracking_before'][
                      'controls'
                    ][j]['controls']['interview_date']
                  "
                  [label]="'Date d\'entretien'"
                ></app-date-input>
              </div>
              <div>
                <app-select-input
                  [formControl]="
                    INSERTION.controls['list']['controls'][i]['controls']['tracking_before'][
                      'controls'
                    ][j]['controls']['companyId']
                  "
                  [bold]="true"
                  [label]="'Entreprise'"
                  [options]="(companies$ | async)?.companies"
                  [isObservable]="true"
                  [optionDisplay]="'name'"
                ></app-select-input>
              </div>
              <div>
                <app-text-input
                  [formControl]="
                    INSERTION.controls['list']['controls'][i]['controls']['tracking_before'][
                      'controls'
                    ][j]['controls']['job_position']
                  "
                  [label]="'Poste'"
                ></app-text-input>
              </div>
              <div>
                <app-textarea-input
                  [formControl]="
                    INSERTION.controls['list']['controls'][i]['controls']['tracking_before'][
                      'controls'
                    ][j]['controls']['comment']
                  "
                  [label]="'Commentaire'"
                ></app-textarea-input>
              </div>
            </div>
          </ng-container>
        </div>
      </ng-container>
    </div>

    <!-- Insertion Details Section -->
    <div class="form-section">
      <div class="section-header">
        <div class="section-icon">
          <mat-icon>work</mat-icon>
        </div>
        <h4 class="section-title">Insertion Professionnelle</h4>
      </div>

      <div class="insertion-card">
        <ng-container
          [formGroup]="INSERTION.controls['list']['controls'][i]['controls']['tracking_after']"
        >
          <div class="form-grid">
            <div>
              <app-select-input
                [formControl]="
                  INSERTION.controls['list']['controls'][i]['controls']['tracking_after']['controls'][
                    'category'
                  ]
                "
                [bold]="true"
                [label]="'Catégorie'"
                [options]="Data.CATEGORIES"
                (valueChange)="onChangeCategory($event)"
              ></app-select-input>
            </div>
            <div>
              <app-select-input #contract_type
                [formControl]="
                  INSERTION.controls['list']['controls'][i]['controls']['tracking_after']['controls'][
                    'contract_type'
                  ]
                "
                [bold]="true"
                [label]="'Type de contrat'"
                [options]="CONTRACT_TYPE"
                [textTransform]="'uppercase'"
              ></app-select-input>
            </div>
            <div>
              <app-select-input
                [formControl]="
                  INSERTION.controls['list']['controls'][i]['controls']['tracking_after']['controls'][
                    'companyId'
                  ]
                "
                [bold]="true"
                [label]="'Entreprise'"
                [options]="(companies$ | async)?.companies"
                [isObservable]="true"
                [optionDisplay]="'name'"
              ></app-select-input>
            </div>
            <div class="toggle-field">
              <mat-slide-toggle #isJobExists
                [formControl]="
                  INSERTION.controls['list']['controls'][i]['controls']['tracking_after']['controls'][
                    'isJobExists'
                  ]
                ">
                Offre existante
              </mat-slide-toggle>
            </div>
            <div *ngIf="isJobExists?.checked">
              <app-select-input
                [formControl]="
                  INSERTION.controls['list']['controls'][i]['controls']['tracking_after']['controls'][
                    'jobId'
                  ]
                "
                [bold]="true"
                [label]="'Offre d\'emploi'"
                [options]="(jobs$ | async)"
                [isObservable]="true"
                [optionDisplay]="'reference'"
              ></app-select-input>
            </div>
            <div>
              <app-date-input
                [formControl]="
                  INSERTION.controls['list']['controls'][i]['controls']['tracking_after']['controls'][
                    'start_date'
                  ]
                "
                [label]="'Date début'"
              ></app-date-input>
            </div>
            <div>
              <app-date-input
                [formControl]="
                  INSERTION.controls['list']['controls'][i]['controls']['tracking_after']['controls'][
                    'end_date'
                  ]
                "
                [label]="'Date fin'"
              ></app-date-input>
            </div>
            <div>
              <app-select-input
                [formControl]="
                  INSERTION.controls['list']['controls'][i]['controls']['tracking_after']['controls'][
                    'function_type'
                  ]
                "
                [bold]="true"
                [label]="'Type de poste'"
                [options]="Data.JOB_TYPES"
              ></app-select-input>
            </div>
            <div>
              <app-text-input
                [formControl]="
                  INSERTION.controls['list']['controls'][i]['controls']['tracking_after']['controls'][
                    'function'
                  ]
                "
                [label]="'Poste'"
              ></app-text-input>
            </div>
            <div>
              <app-select-input
                [formControl]="
                  INSERTION.controls['list']['controls'][i]['controls']['tracking_after']['controls'][
                    'insertion_type'
                  ]
                "
                [bold]="true"
                [label]="'Type d\'insertion'"
                [options]="Data.INSERTION_TYPE"
              ></app-select-input>
            </div>
            <div>
              <app-select-input
                [formControl]="
                  INSERTION.controls['list']['controls'][i]['controls']['tracking_after']['controls'][
                    'duration'
                  ]
                "
                [bold]="true"
                [label]="'Durée'"
                [options]="Data.JOB_DURATION"
              ></app-select-input>
            </div>
            <div>
              <app-select-input
                [formControl]="
                  INSERTION.controls['list']['controls'][i]['controls']['tracking_after']['controls'][
                    'salary'
                  ]
                "
                [bold]="true"
                [label]="'Salaire'"
                [options]="Data.SALARIES"
              ></app-select-input>
            </div>
            <div>
              <app-select-input
                [formControl]="
                  INSERTION.controls['list']['controls'][i]['controls']['tracking_after']['controls'][
                    'cnss'
                  ]
                "
                [bold]="true"
                [label]="'CNSS'"
                [options]="Data.YES_OR_NO"
                [deselectValue]="false"
              ></app-select-input>
            </div>
            <div>
              <app-select-input
                [formControl]="
                  INSERTION.controls['list']['controls'][i]['controls']['tracking_after']['controls'][
                    'justificative_type'
                  ]
                "
                [bold]="true"
                [label]="'Type de justification'"
                [options]="Data.JUSTIFICATIVE_TYPE"
              ></app-select-input>
            </div>
            <div>
              <app-file-input
                [formControl]="
                  INSERTION.controls['list']['controls'][i]['controls']['tracking_after']['controls'][
                    'justification'
                  ]
                "
                [label]="'Justificatif'"
                [accept]="'.pdf'"
                [disabled]="!isValidToInsertion"
              ></app-file-input>
            </div>
          </div>

          <!-- Validation Warning -->
          <div class="validation-warning" *ngIf="!isValidToInsertion">
            <div class="warning-icon">
              <mat-icon>warning</mat-icon>
            </div>
            <p class="warning-text">
              Veuillez remplir tous les champs d'insertion pour activer l'envoi de formulaire.
            </p>
          </div>
        </ng-container>
      </div>
    </div>

  </ng-container>
</ng-container>
